<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Body Make Program</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Mobile Viewport Fixes */
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden; 
            position: fixed; 
            inset: 0;
        }

        body { 
            font-family: 'Noto Sans JP', sans-serif; 
            background-color: #f0f2f5;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .material-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .progress-ring__circle { transition: stroke-dashoffset 0.1s linear; transform: rotate(-90deg); transform-origin: 50% 50%; }

        /* Pulse animation for beat */
        .beat-pulse { animation: beat 0.5s ease-in-out; }
        @keyframes beat { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* Hide Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="text-gray-800 flex flex-col">

    <!-- Header -->
    <header class="bg-indigo-600 text-white shadow-lg z-20 flex-none h-16 flex items-center justify-between px-4 relative w-full">
        <div class="flex items-center">
            <button id="menu-btn" class="p-2 rounded-full hover:bg-indigo-500 transition focus:outline-none md:hidden active:bg-indigo-700">
                <i class="fas fa-bars text-xl"></i>
            </button>
            <h1 class="text-xl font-bold ml-3 md:ml-0 flex items-center gap-2">
                <i class="fas fa-dumbbell"></i> Body Make
            </h1>
        </div>
        <div class="text-sm font-light opacity-90 hidden md:block">理想の自分へ、13kg減</div>
    </header>

    <div class="flex flex-1 w-full relative overflow-hidden">
        
        <!-- Sidebar Navigation -->
        <aside id="sidebar" class="bg-white w-72 shadow-2xl transform -translate-x-full md:translate-x-0 transition-transform duration-300 fixed inset-y-0 left-0 md:relative md:inset-auto z-50 flex flex-col border-r border-gray-200 h-full">
            <div class="p-4 h-16 border-b border-gray-100 bg-indigo-50 flex justify-between items-center flex-none">
                <p class="text-xs text-gray-500 font-bold uppercase tracking-wider">Menu</p>
                <button id="menu-close-btn" class="md:hidden text-gray-500 hover:text-indigo-600 focus:outline-none p-2">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <nav class="flex-1 overflow-y-auto py-2">
                <a href="#" onclick="switchView('diet')" class="nav-item block px-6 py-3 text-gray-600 hover:bg-indigo-50 hover:text-indigo-600 border-l-4 border-transparent hover:border-indigo-600 transition flex items-center gap-3">
                    <i class="fas fa-utensils w-5 text-center"></i> 食事ルール
                </a>
                <div class="mt-4 px-6 mb-2 text-xs font-bold text-gray-400 uppercase">Exercise Phases</div>
                <a href="#" onclick="switchView('phase1')" class="nav-item block px-6 py-3 text-gray-600 hover:bg-indigo-50 hover:text-indigo-600 border-l-4 border-transparent hover:border-indigo-600 transition flex items-center gap-3">
                    <i class="fas fa-seedling w-5 text-center"></i> 第1フェーズ<br><span class="text-xs text-gray-400 font-normal ml-1">基礎代謝覚醒</span>
                </a>
                <a href="#" onclick="switchView('phase2')" class="nav-item block px-6 py-3 text-gray-600 hover:bg-indigo-50 hover:text-indigo-600 border-l-4 border-transparent hover:border-indigo-600 transition flex items-center gap-3">
                    <i class="fas fa-fire w-5 text-center"></i> 第2フェーズ<br><span class="text-xs text-gray-400 font-normal ml-1">強度アップ</span>
                </a>
                <a href="#" onclick="switchView('phase3')" class="nav-item block px-6 py-3 text-gray-600 hover:bg-indigo-50 hover:text-indigo-600 border-l-4 border-transparent hover:border-indigo-600 transition flex items-center gap-3">
                    <i class="fas fa-stopwatch w-5 text-center"></i> 第3フェーズ<br><span class="text-xs text-gray-400 font-normal ml-1">HIIT燃焼</span>
                </a>
            </nav>
        </aside>

        <!-- Overlay for mobile sidebar -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden backdrop-blur-sm transition-opacity"></div>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto w-full relative h-full -webkit-overflow-scrolling-touch" id="main-content">
            <div class="p-4 md:p-8 pb-24">
                <!-- Content injected via JS -->
            </div>
        </main>
    </div>

    <!-- Workout Overlay -->
    <div id="workout-overlay" class="fixed inset-0 bg-gray-900 text-white z-[60] hidden flex flex-col h-full w-full">
        <!-- Overlay Header -->
        <div class="flex justify-between items-center p-4 border-b border-gray-700 flex-none bg-gray-900">
            <div class="text-sm text-gray-400" id="workout-progress">Set 1/3</div>
            <button onclick="closeWorkout()" class="text-gray-400 hover:text-white p-2"><i class="fas fa-times text-2xl"></i></button>
        </div>

        <!-- Workout Content -->
        <div class="flex-1 flex flex-col items-center justify-center p-4 text-center overflow-y-auto">
            
            <div class="mb-6 relative flex-none">
                <!-- Visual Circle -->
                <div id="visual-circle" class="w-56 h-56 md:w-64 md:h-64 rounded-full border-4 border-gray-700 flex items-center justify-center bg-gray-800 relative shadow-lg">
                    
                    <!-- Icon (Visible before start) -->
                    <i id="workout-icon" class="fas fa-play text-6xl text-indigo-500 ml-2"></i>

                    <!-- Timer SVG (Visible during workout) -->
                    <svg class="absolute inset-0 w-full h-full transform -rotate-90 pointer-events-none" style="display:none;" id="timer-svg">
                       <!-- Background Circle -->
                       <circle cx="50%" cy="50%" r="48%" fill="transparent" stroke="#1f2937" stroke-width="8" />
                       <!-- Progress Circle -->
                       <circle id="timer-circle" class="progress-ring__circle" cx="50%" cy="50%" r="48%" fill="transparent" stroke="#818cf8" stroke-width="8" stroke-dasharray="100 100" stroke-dashoffset="0" />
                    </svg>
                    
                    <!-- Text Display -->
                    <div id="timer-container" class="absolute inset-0 flex flex-col items-center justify-center hidden">
                        <div id="timer-label" class="text-sm text-gray-400 font-bold uppercase mb-1">REPS LEFT</div>
                        <div id="timer-text" class="text-7xl font-bold font-mono leading-none">15</div>
                        <div id="timer-sub" class="text-sm text-indigo-400 mt-2 font-mono">Pace: 4s</div>
                    </div>
                </div>
            </div>

            <h2 id="workout-title" class="text-2xl md:text-3xl font-bold mb-2">Wide Squat</h2>
            <p id="workout-desc" class="text-lg md:text-xl text-indigo-300 mb-6">15回</p>
            
            <div id="workout-instruction" class="bg-gray-800 p-4 rounded-lg text-gray-300 text-sm max-w-md w-full mb-8 border-l-4 border-indigo-500">
                意識：膝を外に向け内ももで耐える
            </div>

            <div class="flex flex-col gap-4 flex-none w-full max-w-xs">
                 <button id="main-action-btn" onclick="nextWorkoutStep()" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 px-8 rounded-full text-xl shadow-[0_0_15px_rgba(79,70,229,0.5)] transform transition active:scale-95 flex items-center justify-center gap-3 w-full">
                    <i class="fas fa-play"></i> <span>START WORKOUT</span>
                 </button>
                 
                 <div class="flex flex-col items-center gap-2 mt-2">
                    <div class="flex items-center gap-2 text-xs text-gray-500" id="bgm-status-container">
                        <span id="bgm-status"><i class="fas fa-music mr-1"></i> Music Ready</span>
                    </div>
                 </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // --- Screen Wake Lock System (Prevent Sleep) ---
        let wakeLock = null;

        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Screen Wake Lock active');
                    
                    // Re-acquire lock if visibility changes (e.g. user switches tabs and comes back)
                    wakeLock.addEventListener('release', () => {
                        console.log('Screen Wake Lock released');
                    });
                } catch (err) {
                    console.error('Wake Lock error:', err.name, err.message);
                }
            }
        }

        async function releaseWakeLock() {
            if (wakeLock !== null) {
                await wakeLock.release();
                wakeLock = null;
                console.log('Screen Wake Lock manually released');
            }
        }

        // Handle visibility change to re-acquire lock if app was backgrounded during workout
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock === null && document.visibilityState === 'visible' && !document.getElementById('workout-overlay').classList.contains('hidden')) {
                // If workout is active (overlay visible) but lock is lost, try to get it back
                await requestWakeLock();
            }
        });

        // --- BGM System (SoundHelix Only with Loop) ---
        class BGMSystem {
            constructor() {
                this.audio = new Audio();
                this.audio.loop = true; // Auto-loop enabled
                this.audio.volume = 0.5;
                this.isPlaying = false;
                
                // SoundHelix Test Files (Reliable MP3s)
                this.playlists = {
                    low: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-15.mp3", // Calm
                    mid: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3",  // Upbeat
                    high: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3"   // Intense
                };

                // Error Handling for Audio
                this.audio.addEventListener('error', (e) => {
                    console.error("Audio Load Error", e);
                    if(this.isPlaying) {
                        document.getElementById('bgm-status').innerText = "BGM Load Failed";
                        document.getElementById('bgm-status').classList.add('text-red-500');
                    }
                });
            }

            play(bpm = 110) {
                if (this.isPlaying) return;

                // Select track based on BPM/Phase
                let track = this.playlists.low;
                let intensity = "Relaxed";
                
                if (bpm >= 135) {
                    track = this.playlists.high;
                    intensity = "High Energy";
                } else if (bpm >= 120) {
                    track = this.playlists.mid;
                    intensity = "Upbeat";
                }

                this.audio.src = track;
                // Loop is already true from constructor

                this.audio.play().then(() => {
                    this.isPlaying = true;
                    document.getElementById('bgm-status').innerHTML = `<i class="fas fa-music"></i> BGM: ON (${intensity})`;
                    document.getElementById('bgm-status').classList.remove('text-red-500');
                }).catch(e => {
                    console.log("Auto-play blocked or failed", e);
                    // Mobile browsers often block auto-play until user interaction.
                    document.getElementById('bgm-status').innerText = "Tap Start to Play Music";
                });
            }

            stop() {
                this.audio.pause();
                this.audio.currentTime = 0;
                this.isPlaying = false;
                document.getElementById('bgm-status').innerHTML = '<i class="fas fa-music mr-1"></i> Music Ready';
            }
        }
        
        const bgm = new BGMSystem();

        // --- Data Definitions ---
        // (Diet data kept same)
        const dietData = {
            weekday: {
                title: "平日（月〜金）の鉄則",
                desc: "糖質制限＋高タンパクが必須。13kg落とすためのベース作り。",
                rules: [
                    { icon: "fa-bread-slice", text: "糖質は朝と昼のみ「拳1個分(約100g)」。夜は主食抜き（豆腐に置換）。" },
                    { icon: "fa-drumstick-bite", text: "タンパク質は毎食必ず「手のひら1枚分」の肉・魚・卵・大豆製品を食べる。原則むね肉等の動物性タンパク質を優先。" },
                    { icon: "fa-tint", text: "飲み物は水かお茶のみ（目標1日2リットル）。" }
                ]
            },
            weekend: {
                title: "休日（土・日）のルール",
                desc: "",
                rules: [
                    { icon: "fa-utensils", text: "2食連続でドカ食いしないこと。" }
                ]
            }
        };

        const phases = {
            phase1: {
                title: "第1フェーズ：基礎代謝覚醒",
                period: "1/14 〜 2/28",
                desc: "大きな筋肉を目覚めさせ代謝UP。フォーム習得が最重要。",
                interval: 45,
                sets: 3,
                bpm: 110, // ゆったり
                type: "normal",
                days: {
                    Mon: {
                        part: "下半身 (内腿・尻)",
                        menu: [
                            { name: "ワイドスクワット", amount: "15回", tip: "膝を外に向け内ももで耐える", type: "reps", count: 15 },
                            { name: "グルートブリッジ", amount: "15回", tip: "お尻の穴をキュッと締める", type: "reps", count: 15 },
                            { name: "バックランジ", amount: "左右各10回", tip: "前足のかかとに重心を乗せる", type: "reps", count: 20 }
                        ]
                    },
                    Tue: {
                        part: "上半身 (胸・背中)",
                        menu: [
                            { name: "膝つきプッシュアップ", amount: "10回", tip: "胸の筋肉が伸び縮みするのを感じる", type: "reps", count: 10 },
                            { name: "リバーススノーエンジェル", amount: "15回", tip: "肩甲骨を寄せて下げる", type: "reps", count: 15 },
                            { name: "リバースプランク", amount: "30秒キープ", tip: "背中とお尻を持ち上げ一直線に", type: "time", duration: 30 }
                        ]
                    },
                    Wed: {
                        part: "お腹 (くびれ)",
                        menu: [
                            { name: "ニートゥチェスト", amount: "15回", tip: "腰を反らさず下腹部で足を引き寄せる", type: "reps", count: 15 },
                            { name: "ツイストクランチ", amount: "左右各10回", tip: "おへそを覗き込みながらねじる", type: "reps", count: 20 },
                            { name: "プランク", amount: "45秒キープ", tip: "お腹に力を入れ腰を反らない", type: "time", duration: 45 }
                        ]
                    },
                    Thu: {
                        part: "下半身 (脚線美)",
                        menu: [
                            { name: "ナロースクワット", amount: "15回", tip: "足を閉じ、前ももを意識して座る", type: "reps", count: 15 },
                            { name: "サイドレッグレイズ", amount: "左右各15回", tip: "真横に上げ、お尻の横に効かせる", type: "reps", count: 30 },
                            { name: "カーフレイズ", amount: "30回", tip: "ふくらはぎの収縮を意識", type: "reps", count: 30 }
                        ]
                    },
                    Fri: {
                        part: "全身 (連動性)",
                        menu: [
                            { name: "スロー・マウンテンクライマー", amount: "左右各10回", tip: "体幹を固定し膝を胸に引き寄せる", type: "reps", count: 20 },
                            { name: "ハンドウォーク", amount: "8回", tip: "尺取虫のように床を歩く", type: "reps", count: 8 },
                            { name: "スクワットパルス", amount: "30秒", tip: "小刻みに弾み、太ももの熱を感じる", type: "time", duration: 30 }
                        ]
                    }
                }
            },
            phase2: {
                title: "第2フェーズ：強度アップ",
                period: "3/1 〜 3/31",
                desc: "停滞期打破。片足種目や複合種目で負荷を高める。",
                interval: 30,
                sets: 3,
                bpm: 125, // 少しアップテンポ
                type: "normal",
                days: {
                    Mon: {
                        part: "下半身 (強度強)",
                        menu: [
                            { name: "ブルガリアンスクワット", amount: "左右各10回", tip: "椅子に片足を乗せて深く沈む", type: "reps", count: 20 },
                            { name: "シングルレッグ・ヒップリフト", amount: "左右各12回", tip: "片足でお尻を持ち上げる", type: "reps", count: 24 },
                            { name: "スモウスクワット・ホールド", amount: "30秒キープ", tip: "深くしゃがんだ状態で耐える", type: "time", duration: 30 }
                        ]
                    },
                    Tue: {
                        part: "上半身 (メリハリ)",
                        menu: [
                            { name: "パイクプッシュアップ", amount: "10回", tip: "お尻を高く上げ肩と二の腕に効かせる", type: "reps", count: 10 },
                            { name: "プランク・アップダウン", amount: "10回", tip: "肘つき←→手のひらつきを繰り返す", type: "reps", count: 10 },
                            { name: "スーパーマン", amount: "15回", tip: "うつ伏せで手足を浮かせ背筋収縮", type: "reps", count: 15 }
                        ]
                    },
                    Wed: {
                        part: "お腹 (下腹撃退)",
                        menu: [
                            { name: "レッグレイズ", amount: "15回", tip: "腰が浮かない範囲で足を上下", type: "reps", count: 15 },
                            { name: "ロシアンツイスト", amount: "左右各15回", tip: "体育座りで上体を左右に捻る", type: "reps", count: 30 },
                            { name: "サイドプランク", amount: "左右30秒", tip: "脇腹の筋肉で身体を支える", type: "time", duration: 60 }
                        ]
                    },
                    Thu: {
                        part: "下半身 (ヒップ)",
                        menu: [
                            { name: "クロスランジ", amount: "左右各12回", tip: "斜め後ろに足を引く", type: "reps", count: 24 },
                            { name: "ドンキーキック", amount: "左右各15回", tip: "四つん這いで足を天井へ蹴り上げる", type: "reps", count: 30 },
                            { name: "ヒップアブダクション", amount: "左右各15回", tip: "横寝で足を高く上げる", type: "reps", count: 30 }
                        ]
                    },
                    Fri: {
                        part: "全身 (燃焼系)",
                        menu: [
                            { name: "バーピー（ジャンプなし）", amount: "10回", tip: "立つ・しゃがむ・手をつく・足を伸ばす", type: "reps", count: 10 },
                            { name: "ベアクロール", amount: "30秒", tip: "膝を浮かせた四つん這いで移動", type: "time", duration: 30 },
                            { name: "バイシクルクランチ", amount: "左右各15回", tip: "自転車を漕ぐように腹筋", type: "reps", count: 30 }
                        ]
                    }
                }
            },
            phase3: {
                title: "第3フェーズ：HIIT (脂肪燃焼)",
                period: "4/1 〜 目標達成まで",
                desc: "30秒全力→10秒休憩。心拍数を上げて脂肪を燃やす。",
                interval: 10,
                sets: 3,
                bpm: 140, // 高速
                type: "hiit",
                days: {
                    Mon: {
                        part: "脂肪燃焼A",
                        menu: [
                            { name: "ジャンピングスクワット", amount: "30秒全力", tip: "休憩中も足踏み", type: "time", duration: 30 },
                            { name: "マウンテンクライマー(高速)", amount: "30秒全力", tip: "動きを止めない", type: "time", duration: 30 },
                            { name: "バックランジ・ニーアップ", amount: "30秒全力", tip: "キツくなってからが勝負", type: "time", duration: 30 },
                            { name: "バーピー(ジャンプあり)", amount: "30秒全力", tip: "最大強度で！", type: "time", duration: 30 }
                        ]
                    },
                    Tue: {
                        part: "上半身集中",
                        menu: [
                            { name: "プッシュアップ＆ローテーション", amount: "30秒全力", tip: "腕立て後に片手を天井へ", type: "time", duration: 30 },
                            { name: "プランクジャック", amount: "30秒全力", tip: "足を開閉", type: "time", duration: 30 },
                            { name: "トライセプスディップス", amount: "30秒全力", tip: "二の腕を焼き尽くす", type: "time", duration: 30 },
                            { name: "シャドーボクシング", amount: "30秒全力", tip: "全力でパンチ", type: "time", duration: 30 }
                        ]
                    },
                    Wed: {
                        part: "脂肪燃焼B (月曜同)",
                        menu: [
                            { name: "ジャンピングスクワット", amount: "30秒全力", tip: "回数を増やすことに挑戦", type: "time", duration: 30 },
                            { name: "マウンテンクライマー(高速)", amount: "30秒全力", tip: "動きを止めない", type: "time", duration: 30 },
                            { name: "バックランジ・ニーアップ", amount: "30秒全力", tip: "キツくなってからが勝負", type: "time", duration: 30 },
                            { name: "バーピー(ジャンプあり)", amount: "30秒全力", tip: "最大強度で！", type: "time", duration: 30 }
                        ]
                    },
                    Thu: {
                        part: "腹筋地獄",
                        menu: [
                            { name: "Vシットアップ", amount: "30秒全力", tip: "腹筋を休ませない", type: "time", duration: 30 },
                            { name: "マウンテンクライマー(捻り)", amount: "30秒全力", tip: "脇腹を意識", type: "time", duration: 30 },
                            { name: "プランク・ヒップツイスト", amount: "30秒全力", tip: "お尻を左右に振る", type: "time", duration: 30 },
                            { name: "ハイニーズ", amount: "30秒全力", tip: "腿上げダッシュ！心拍数MAX", type: "time", duration: 30 }
                        ]
                    },
                    Fri: {
                        part: "全身限界 (火曜同)",
                         menu: [
                            { name: "プッシュアップ＆ローテーション", amount: "30秒全力", tip: "週末のために使い切る", type: "time", duration: 30 },
                            { name: "プランクジャック", amount: "30秒全力", tip: "足を開閉", type: "time", duration: 30 },
                            { name: "トライセプスディップス", amount: "30秒全力", tip: "二の腕を焼き尽くす", type: "time", duration: 30 },
                            { name: "シャドーボクシング", amount: "30秒全力", tip: "全力でパンチ", type: "time", duration: 30 }
                        ]
                    }
                }
            }
        };

        const dayMap = { "Mon": "月", "Tue": "火", "Wed": "水", "Thu": "木", "Fri": "金" };
        let currentPhase = 'diet';
        let activeWorkoutQueue = [];
        let currentQueueIndex = 0;
        let timerInterval = null;
        let currentPhaseBPM = 120;

        // --- View Logic ---

        function init() {
            switchView('diet'); // Default view
        }

        function switchView(viewName) {
            currentPhase = viewName;
            const mainContent = document.querySelector('#main-content > div');
            
            // Highlight sidebar
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('bg-indigo-50', 'text-indigo-600', 'border-indigo-600');
                if(el.getAttribute('onclick').includes(viewName)) {
                    el.classList.add('bg-indigo-50', 'text-indigo-600', 'border-indigo-600');
                }
            });

            // Mobile menu close
            document.getElementById('sidebar').classList.add('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.add('hidden');

            if (viewName === 'diet') {
                renderDiet(mainContent);
            } else {
                renderPhase(mainContent, viewName);
            }
        }

        function renderDiet(container) {
            let html = `
                <div class="max-w-4xl mx-auto fade-in">
                    <h2 class="text-3xl font-bold mb-6 text-indigo-800 border-b-2 border-indigo-200 pb-2">食事ルール <span class="text-sm font-normal text-gray-500 ml-2">Diet Rules</span></h2>
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <!-- Weekday Card -->
                        <div class="bg-white rounded-xl p-6 material-shadow border-t-4 border-indigo-500">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h3 class="text-xl font-bold text-gray-800">${dietData.weekday.title}</h3>
                                    <p class="text-sm text-gray-500 mt-1">${dietData.weekday.desc}</p>
                                </div>
                                <div class="bg-indigo-100 p-2 rounded-lg"><i class="fas fa-briefcase text-indigo-600 text-xl"></i></div>
                            </div>
                            <ul class="space-y-4">
                                ${dietData.weekday.rules.map(rule => `
                                    <li class="flex items-start gap-3">
                                        <i class="fas ${rule.icon} mt-1 text-pink-500"></i>
                                        <span class="text-gray-700 leading-relaxed">${rule.text}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>

                        <!-- Weekend Card -->
                        <div class="bg-white rounded-xl p-6 material-shadow border-t-4 border-green-500">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h3 class="text-xl font-bold text-gray-800">${dietData.weekend.title}</h3>
                                    <p class="text-sm text-gray-500 mt-1">${dietData.weekend.desc}</p>
                                </div>
                                <div class="bg-green-100 p-2 rounded-lg"><i class="fas fa-glass-cheers text-green-600 text-xl"></i></div>
                            </div>
                            <ul class="space-y-4">
                                ${dietData.weekend.rules.map(rule => `
                                    <li class="flex items-start gap-3">
                                        <i class="fas ${rule.icon} mt-1 text-green-500"></i>
                                        <span class="text-gray-700 leading-relaxed">${rule.text}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>

                    <div class="mt-8 bg-blue-50 p-6 rounded-xl border border-blue-100">
                         <h4 class="font-bold text-blue-800 mb-2"><i class="fas fa-info-circle"></i> 成功のポイント</h4>
                         <p class="text-blue-700">平日は「糖質オフ」と「タンパク質」を徹底。週末はリラックス。このメリハリが13kg減への鍵です。</p>
                    </div>
                </div>
            `;
            container.innerHTML = html;
        }

        function renderPhase(container, phaseKey) {
            const data = phases[phaseKey];
            currentPhaseBPM = data.bpm || 120;
            let html = `
                <div class="max-w-4xl mx-auto fade-in">
                    <div class="mb-8">
                        <span class="text-xs font-bold tracking-wider text-indigo-500 uppercase bg-indigo-50 px-2 py-1 rounded">${data.period}</span>
                        <h2 class="text-3xl font-bold mt-2 text-gray-800">${data.title}</h2>
                        <div class="flex gap-4 mt-3 text-sm text-gray-500">
                            <span><i class="fas fa-layer-group"></i> ${data.sets} Sets</span>
                            <span><i class="fas fa-hourglass-half"></i> Rest ${data.interval}s</span>
                            <span><i class="fas fa-music"></i> BPM ${currentPhaseBPM}</span>
                        </div>
                    </div>

                    <!-- Day Tabs -->
                    <div class="flex overflow-x-auto gap-2 mb-6 pb-2 no-scrollbar" id="day-tabs">
                        ${Object.keys(data.days).map((day, index) => `
                            <button onclick="renderDayContent('${phaseKey}', '${day}')" 
                                class="day-tab flex-none px-6 py-3 rounded-full border border-gray-200 shadow-sm transition duration-200 ${index === 0 ? 'active-tab' : ''}" data-day="${day}">
                                <span class="font-bold mr-1">${dayMap[day]}</span>
                            </button>
                        `).join('')}
                    </div>

                    <!-- Day Content Area -->
                    <div id="day-content" class="fade-in">
                        <!-- Loaded via JS -->
                    </div>
                </div>
            `;
            container.innerHTML = html;
            
            // Render Monday by default
            renderDayContent(phaseKey, 'Mon');
        }

        function renderDayContent(phaseKey, dayKey) {
            const phase = phases[phaseKey];
            const dayData = phase.days[dayKey];
            const container = document.getElementById('day-content');

            // Update tab styles
            document.querySelectorAll('.day-tab').forEach(btn => {
                if(btn.dataset.day === dayKey) {
                    btn.classList.add('bg-indigo-600', 'text-white');
                    btn.classList.remove('bg-white', 'text-gray-600');
                } else {
                    btn.classList.remove('bg-indigo-600', 'text-white');
                    btn.classList.add('bg-white', 'text-gray-600');
                }
            });

            let html = `
                <div class="bg-white rounded-2xl p-6 md:p-8 material-shadow relative overflow-hidden mb-24">
                    <div class="flex justify-between items-center mb-6 relative z-10">
                        <h3 class="text-2xl font-bold text-gray-800 flex items-center gap-3">
                            <span class="bg-indigo-100 text-indigo-600 w-10 h-10 rounded-full flex items-center justify-center text-lg shadow-sm">
                                ${dayMap[dayKey]}
                            </span>
                            ${dayData.part}
                        </h3>
                    </div>

                    <div class="space-y-4 mb-8 relative z-10">
                        ${dayData.menu.map((item, idx) => `
                            <div class="flex items-start gap-4 p-4 rounded-xl hover:bg-gray-50 transition border border-gray-100">
                                <div class="font-bold text-gray-300 text-xl w-6">0${idx+1}</div>
                                <div class="flex-1">
                                    <div class="flex items-center justify-between">
                                        <h4 class="font-bold text-gray-800 text-lg">${item.name}</h4>
                                        <a href="https://www.youtube.com/results?search_query=${encodeURIComponent(item.name + ' フォーム トレーニング')}" 
                                           target="_blank" 
                                           class="text-red-500 hover:text-red-600 bg-red-50 hover:bg-red-100 p-2 rounded-full transition"
                                           title="YouTubeでフォームを確認">
                                            <i class="fab fa-youtube text-lg"></i>
                                        </a>
                                    </div>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span class="text-indigo-600 font-bold text-sm px-2 py-0.5 rounded border border-indigo-100 bg-indigo-50">${item.amount}</span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2"><i class="fas fa-lightbulb text-yellow-500 mr-1"></i>${item.tip}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="text-center sticky bottom-0 bg-white pt-4 pb-2 border-t border-gray-100 z-10">
                        <button onclick="startWorkout('${phaseKey}', '${dayKey}')" class="bg-gradient-to-r from-pink-500 to-indigo-600 text-white font-bold py-4 px-12 rounded-full text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition w-full md:w-auto ripple">
                            <i class="fas fa-play mr-2"></i> START
                        </button>
                    </div>
                </div>
            `;
            container.innerHTML = html;
        }

        // --- Timer / Workout Logic ---

        function startWorkout(phaseKey, dayKey) {
            const phase = phases[phaseKey];
            const dayMenu = phase.days[dayKey].menu;
            currentPhaseBPM = phase.bpm || 120;
            
            // Activate Wake Lock
            requestWakeLock();

            // Build Queue
            activeWorkoutQueue = [];
            
            for (let s = 1; s <= phase.sets; s++) {
                dayMenu.forEach((item, idx) => {
                    // Exercise
                    activeWorkoutQueue.push({
                        type: 'exercise',
                        data: item,
                        set: s,
                        totalSets: phase.sets
                    });
                    
                    // Rest (Don't add rest after the very last exercise of the last set)
                    if (!(s === phase.sets && idx === dayMenu.length - 1)) {
                         // Specific HIIT logic: 10s rest, else phase interval
                         let restTime = phase.interval; 
                         activeWorkoutQueue.push({
                            type: 'rest',
                            duration: restTime,
                            set: s,
                            totalSets: phase.sets,
                            nextName: (idx === dayMenu.length - 1) ? (s < phase.sets ? dayMenu[0].name : "Finish") : dayMenu[idx+1].name
                        });
                    }
                });
            }

            activeWorkoutQueue.push({ type: 'finish' });
            
            currentQueueIndex = 0;
            document.getElementById('workout-overlay').classList.remove('hidden');
            
            // Start BGM immediately
            bgm.play(currentPhaseBPM);
            
            // Render first step
            renderWorkoutStep(false); 
        }

        function closeWorkout() {
            if(confirm("トレーニングを終了しますか？")) {
                clearInterval(timerInterval);
                bgm.stop();
                releaseWakeLock(); // Release lock on manual close
                document.getElementById('workout-overlay').classList.add('hidden');
            }
        }

        function playSound(type) {
             // Use simple oscillator for sound effects (Timer Beep)
             const AudioContext = window.AudioContext || window.webkitAudioContext;
             const ctx = new AudioContext(); // Separate context for SFX
             const osc = ctx.createOscillator();
             const gain = ctx.createGain();
             osc.connect(gain);
             gain.connect(ctx.destination);
             
             if (type === 'tick') {
                 osc.frequency.value = 1000;
                 gain.gain.value = 0.1;
                 osc.start();
                 osc.stop(ctx.currentTime + 0.1);
             } else if (type === 'end') {
                 osc.frequency.value = 1500;
                 gain.gain.value = 0.2;
                 osc.start();
                 osc.stop(ctx.currentTime + 0.5);
             } else if (type === 'rep') {
                 // Soft tick for reps
                 osc.frequency.value = 600;
                 gain.gain.value = 0.05;
                 osc.start();
                 osc.stop(ctx.currentTime + 0.05);
             }
        }

        function renderWorkoutStep(autoStart = false) {
            const step = activeWorkoutQueue[currentQueueIndex];
            const titleEl = document.getElementById('workout-title');
            const descEl = document.getElementById('workout-desc');
            const progressEl = document.getElementById('workout-progress');
            const instrEl = document.getElementById('workout-instruction');
            const mainBtn = document.getElementById('main-action-btn');
            
            const timerSvg = document.getElementById('timer-svg');
            const timerContainer = document.getElementById('timer-container');
            const iconEl = document.getElementById('workout-icon');

            // Reset UI
            clearInterval(timerInterval);
            timerSvg.style.display = 'none';
            timerContainer.classList.add('hidden');
            iconEl.classList.remove('hidden');
            instrEl.classList.remove('hidden');

            if (step.type === 'exercise') {
                progressEl.textContent = `Set ${step.set} / ${step.totalSets}`;
                titleEl.textContent = step.data.name;
                descEl.textContent = step.data.amount;
                instrEl.innerHTML = `<span class="text-indigo-400 font-bold">意識:</span> ${step.data.tip}`;
                
                // Icon
                iconEl.className = "fas fa-play text-6xl text-indigo-500 ml-2";

                // Setup Button
                mainBtn.innerHTML = '<i class="fas fa-play"></i> <span>GO!</span>';
                mainBtn.className = "bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 px-8 rounded-full text-xl shadow-lg w-full flex justify-center gap-2";
                
                // Determine Duration
                let duration;
                let isReps = false;
                if (step.data.type === 'time') {
                    duration = step.data.duration;
                } else {
                    // Reps logic: 4 seconds per rep
                    isReps = true;
                    duration = (step.data.count || 10) * 4; 
                }

                mainBtn.onclick = () => startTimer(duration, true, isReps, step.data.count);
                
                if(autoStart) mainBtn.click();

            } else if (step.type === 'rest') {
                progressEl.textContent = "Interval";
                titleEl.textContent = "休憩 (REST)";
                descEl.textContent = `Next: ${step.nextName}`;
                instrEl.classList.add('hidden');
                iconEl.className = "fas fa-coffee text-6xl text-green-400";
                
                mainBtn.innerHTML = '<i class="fas fa-forward"></i> SKIP REST';
                mainBtn.className = "bg-green-600 hover:bg-green-500 text-white font-bold py-4 px-8 rounded-full text-xl shadow-lg w-full flex justify-center gap-2";
                mainBtn.onclick = () => nextWorkoutStep();
                
                startTimer(step.duration, false, false);

            } else if (step.type === 'finish') {
                progressEl.textContent = "Complete";
                titleEl.textContent = "お疲れ様でした！";
                descEl.textContent = "本日のメニュー達成です";
                iconEl.className = "fas fa-trophy text-6xl text-yellow-400";
                instrEl.classList.add('hidden');
                mainBtn.innerHTML = 'CLOSE';
                mainBtn.onclick = () => { 
                    bgm.stop();
                    releaseWakeLock(); // Release lock on completion
                    document.getElementById('workout-overlay').classList.add('hidden'); 
                };
            }
        }

        function startTimer(seconds, isExercise, isRepsMode, totalReps) {
            const timerText = document.getElementById('timer-text');
            const timerLabel = document.getElementById('timer-label');
            const timerSub = document.getElementById('timer-sub');
            const timerCircle = document.getElementById('timer-circle');
            const iconEl = document.getElementById('workout-icon');
            const mainBtn = document.getElementById('main-action-btn');
            const timerSvg = document.getElementById('timer-svg');
            const timerContainer = document.getElementById('timer-container');
            const visualCircle = document.getElementById('visual-circle');

            // Switch to Timer View
            iconEl.classList.add('hidden');
            timerSvg.style.display = 'block';
            timerContainer.classList.remove('hidden');

            // Visual Pulse
            visualCircle.classList.add('beat-pulse');
            setTimeout(() => visualCircle.classList.remove('beat-pulse'), 500);

            // Circle Props
            const radius = timerCircle.r.baseVal.value;
            // The circumference logic needs to be dynamic based on % or px. 
            // In CSS r=48% roughly maps to screen size. SVG coordinate system is tricky with %.
            // Let's use getBBox or just a standard approximation for the dasharray.
            // Simplified: Use dasharray 100 100 with pathLength="100" if possible, or calculation.
            // Let's assume pathLength is 100 for simplicity in CSS/SVG
            timerCircle.setAttribute("pathLength", "100");
            timerCircle.style.strokeDasharray = "100 100";
            timerCircle.style.strokeDashoffset = "0";
            
            // Colors
            timerCircle.style.stroke = isExercise ? '#818cf8' : '#34d399'; // Indigo or Green
            
            let timeLeft = seconds;
            let timeElapsed = 0;
            
            // Initial Text
            if (isRepsMode) {
                timerLabel.innerText = "REPS LEFT";
                timerText.innerText = totalReps;
                timerSub.innerText = "Pace: 4s / rep";
                timerSub.classList.remove('hidden');
            } else {
                timerLabel.innerText = isExercise ? "TIME LEFT" : "REST";
                timerText.innerText = timeLeft;
                timerSub.classList.add('hidden');
            }

            mainBtn.innerHTML = '<i class="fas fa-step-forward"></i> SKIP';
            mainBtn.className = "bg-gray-700 hover:bg-gray-600 text-white font-bold py-4 px-8 rounded-full text-xl shadow-lg w-full flex justify-center gap-2";
            mainBtn.onclick = () => nextWorkoutStep();

            // Timer Loop
            timerInterval = setInterval(() => {
                timeLeft--;
                timeElapsed++;

                // Logic for Reps vs Time
                if (isRepsMode) {
                    // Update count every 4 seconds
                    const currentRep = Math.ceil(timeLeft / 4);
                    const prevRep = parseInt(timerText.innerText);
                    
                    // Display Reps
                    timerText.innerText = currentRep > 0 ? currentRep : 0;
                    
                    // "Tick" sound on rep change
                    if (timeLeft % 4 === 0 && timeLeft > 0) {
                        playSound('tick');
                        visualCircle.classList.remove('beat-pulse');
                        void visualCircle.offsetWidth; // trigger reflow
                        visualCircle.classList.add('beat-pulse');
                    }
                } else {
                    timerText.innerText = timeLeft;
                    if (timeLeft <= 3 && timeLeft > 0) playSound('tick');
                }

                // Circle Progress (0 to 100)
                const percent = (timeLeft / seconds) * 100;
                const offset = 100 - percent;
                timerCircle.style.strokeDashoffset = offset;

                if (timeLeft <= 0) {
                    playSound('end');
                    clearInterval(timerInterval);
                    nextWorkoutStep();
                }
            }, 1000);
        }

        function nextWorkoutStep() {
            clearInterval(timerInterval);
            currentQueueIndex++;
            renderWorkoutStep(true); // Auto start next step logic
        }

        // --- Interaction Setup ---
        document.getElementById('menu-btn').addEventListener('click', () => {
            document.getElementById('sidebar').classList.remove('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.remove('hidden');
        });

        document.getElementById('menu-close-btn').addEventListener('click', () => {
            document.getElementById('sidebar').classList.add('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.add('hidden');
        });

        document.getElementById('sidebar-overlay').addEventListener('click', () => {
            document.getElementById('sidebar').classList.add('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.add('hidden');
        });

        // Initialize
        init();

    </script>
</body>
</html>
